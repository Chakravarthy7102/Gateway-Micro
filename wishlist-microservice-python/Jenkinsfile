pipeline{
    agent any

    stages{
        stage("Git Checkout"){
            steps{
                git 'https://github.com/Chakravarthy7102/Gateway-Micro.git'
            }
        }

        stage("Docker Build"){
            steps{
                sh 'docker build --tag wishlist:${env.BUILD_NUMBER}'
            }
        }

        stage("Docker Push"){
            steps{
                sh 'docker push chakravarthy712/wishlist:${env.BUILD_NUMBER}'
            }
        }

        stage("Kubernetes apply"){
            steps{
                sh 'cat ../k8s/templates/wishlist-deployment.yaml | grep -i image'
                sh 'sed -i 's/image: wishlist:*/image: wishlist:"${env.BUILD_NUMBER}"/' ../k8s/templates/wishlist-deployment.yaml '
                sh 'kubectl apply -f ../k8s/templates/wishlist-deployment.yaml'
            }
        }

    }
}